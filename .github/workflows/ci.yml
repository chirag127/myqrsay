# CI/CD Pipeline for QuantumCode Dynamic QR Generator
# Enforcing Apex Zero-Defect, High-Velocity Standard (2025/2026)

name: QuantumCode CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# --- MATRIX DEFINITION ---
# Standardizing on Node 20 LTS for Vite/TypeScript environment.
jobs:
  build_and_test:
    name: Build, Lint, & Unit Test
    runs-on: ubuntu-latest
    defaults:
      run:
        # Set working directory to the project root for consistency
        working-directory: .

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20' # LTS
          cache: 'npm'

      - name: Install Dependencies (using uv principle - ultra-fast)
        # Although this is Node, we follow the performance mandate: install only what is needed.
        run: npm ci

      - name: Validate Code Formatting and Linting (Biome/Ruff Equivalent)
        # Using standard npm scripts for linting/formatting validation
        run: npm run lint -- --staged
        # Note: Assuming 'lint' script runs Biome check or equivalent strict linting

      - name: Run Unit Tests (Vitest)
        # Assuming 'test:unit' runs Vitest, providing rapid feedback
        run: npm run test:unit

      - name: Generate Production Build Artifact
        run: npm run build

      - name: Archive Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: quantumcode-build-artifact
          path: dist/
          retention-days: 5

  e2e_deployment_check:
    name: End-to-End Deployment Smoke Test
    needs: build_and_test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: Production_Preview # Placeholder for environment configuration if needed

    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: quantumcode-build-artifact
          path: ./dist

      - name: Setup Playwright for E2E Testing
        uses: microsoft/playwright-github-action@v1
        with:
          node-version: 20

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run End-to-End Tests (Playwright)
        # Assuming 'test:e2e' runs Playwright against a locally served build or staging URL
        run: npx playwright test --project=chromium --reporter=dot
        # Set an environment variable for the base URL if serving locally, e.g.:
        # env:
        #   BASE_URL: http://localhost:3000

  security_scan:
    name: Security Audit (Snyk/Dependabot Equivalent)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies (for audit)
        run: npm ci

      # Placeholder for a modern security scanning tool like Snyk or native GitHub AS
      - name: Apex Security Vulnerability Scan
        run: echo "Running proprietary Apex security analysis on package-lock.json..."
        # In a real scenario, this step would execute a security CLI tool.
        # Example: npx snyk test --severity-threshold=high
        continue-on-error: false
