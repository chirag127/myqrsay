name: CI Pipeline - QuantumCode QR Generator

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# --- APEX 2026 STANDARD - ZERO-DEFECT CONTINUOUS INTEGRATION ---

jobs:
  lint-and-test:
    name: Lint, Format, and Unit Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js Environment (Vite/TS/JS Stack)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: 3. Install Dependencies (using uv/npm for parity)
        run: npm ci

      - name: 4. Format and Lint Check (Biome Standard)
        # Using npm script defined in package.json for Biome execution
        run: npm run lint

      - name: 5. Static Analysis & Type Checking (TypeScript)
        run: npm run check-types

      - name: 6. Execute Vitest Unit Tests
        run: npm run test:unit

      - name: 7. Report Coverage to Codecov
        # Assumes package.json scripts handle coverage generation (e.g., --coverage flag in Vitest)
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          name: QuantumCode-QR-Generator
          flags: unittests

  e2e-test:
    name: End-to-End Testing (Playwright)
    runs-on: ubuntu-latest
    needs: lint-and-test
    permissions:
      contents: read

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: 3. Install Dependencies
        run: npm ci

      - name: 4. Build Application for E2E Testing
        # Assumes 'build' script generates production-ready assets
        run: npm run build

      - name: 5. Execute Playwright End-to-End Tests
        uses: microsoft/playwright-github-action@v1
        with:
          node-version: 20
          # Assumes Playwright tests run against the built output or a local dev server started within the action
          # For a simple utility, we often run tests directly against the built artifact or use 'npm run test:e2e'
          # We will assume the standard 'test:e2e' script handles server startup/teardown or targets static files.
          run: npm run test:e2e

  deploy-preview:
    name: Deploy Preview (If PR)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: lint-and-test
    # Placeholder: In a real scenario, this would deploy to Vercel/Netlify/Cloudflare Pages
    steps:
      - name: Notify Preview Deployment Status
        run: echo "Preview deployment placeholder executed for PR #${{ github.event.number }}"
