<div class="container">
    <div class="page-header">
        <h1>Order Management</h1>
        <div class="action-buttons">
            <a mat-raised-button color="primary" routerLink="/admin/kitchen">
                <mat-icon>kitchen</mat-icon> Kitchen Display
            </a>
        </div>
    </div>

    <div *ngIf="loading" class="loading-spinner">
        <mat-spinner></mat-spinner>
    </div>

    <div *ngIf="error" class="error-message">
        {{ error }}
    </div>

    <div *ngIf="!loading && !error" class="order-management">
        <mat-card>
            <mat-card-content>
                <div class="filters">
                    <mat-form-field appearance="outline">
                        <mat-label>Status</mat-label>
                        <mat-select [formControl]="statusFilter">
                            <mat-option value="">All Statuses</mat-option>
                            <mat-option *ngFor="let status of statuses" [value]="status.value">
                                {{ status.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Order Type</mat-label>
                        <mat-select [formControl]="orderTypeFilter">
                            <mat-option value="">All Types</mat-option>
                            <mat-option *ngFor="let type of orderTypes" [value]="type.value">
                                {{ type.label }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Date</mat-label>
                        <input matInput [matDatepicker]="picker" [formControl]="dateFilter">
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>

                    <button mat-raised-button color="accent" (click)="clearFilters()">
                        <mat-icon>clear</mat-icon> Clear Filters
                    </button>
                </div>

                <div class="table-container">
                    <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z2">
                        <!-- Order Number Column -->
                        <ng-container matColumnDef="orderNumber">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Order #</th>
                            <td mat-cell *matCellDef="let order">{{ order.orderNumber }}</td>
                        </ng-container>

                        <!-- Date Column -->
                        <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                            <td mat-cell *matCellDef="let order">{{ order.createdAt | date:'short' }}</td>
                        </ng-container>

                        <!-- Customer Column -->
                        <ng-container matColumnDef="customer">
                            <th mat-header-cell *matHeaderCellDef>Customer</th>
                            <td mat-cell *matCellDef="let order">
                                {{ order.customer && typeof order.customer !== 'string' ? order.customer.name : 'Guest'
                                }}
                            </td>
                        </ng-container>

                        <!-- Order Type Column -->
                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef>Type</th>
                            <td mat-cell *matCellDef="let order">
                                <span class="order-type-badge" [ngClass]="order.orderType">
                                    {{ order.orderType | titlecase }}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Status Column -->
                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef>Status</th>
                            <td mat-cell *matCellDef="let order">
                                <span class="status-badge" [ngClass]="order.status">
                                    {{ order.status | titlecase }}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Total Column -->
                        <ng-container matColumnDef="total">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Total</th>
                            <td mat-cell *matCellDef="let order">{{ order.total | currency }}</td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let order">
                                <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Order actions">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                                <mat-menu #menu="matMenu">
                                    <button mat-menu-item (click)="openOrderDetail(order)">
                                        <mat-icon>visibility</mat-icon>
                                        <span>View Details</span>
                                    </button>
                                    <button mat-menu-item (click)="printOrder(order)">
                                        <mat-icon>receipt</mat-icon>
                                        <span>Print Bill</span>
                                    </button>
                                    <button mat-menu-item (click)="printKOT(order)">
                                        <mat-icon>print</mat-icon>
                                        <span>Print KOT</span>
                                    </button>
                                    <mat-divider></mat-divider>
                                    <button mat-menu-item *ngIf="order.status === 'pending'"
                                        (click)="updateOrderStatus(order, 'confirmed')">
                                        <mat-icon>check_circle</mat-icon>
                                        <span>Confirm Order</span>
                                    </button>
                                    <button mat-menu-item *ngIf="order.status === 'confirmed'"
                                        (click)="updateOrderStatus(order, 'preparing')">
                                        <mat-icon>restaurant</mat-icon>
                                        <span>Start Preparing</span>
                                    </button>
                                    <button mat-menu-item *ngIf="order.status === 'preparing'"
                                        (click)="updateOrderStatus(order, 'ready')">
                                        <mat-icon>done_all</mat-icon>
                                        <span>Mark as Ready</span>
                                    </button>
                                    <button mat-menu-item
                                        *ngIf="order.status === 'ready' && order.orderType === 'delivery'"
                                        (click)="updateOrderStatus(order, 'out-for-delivery')">
                                        <mat-icon>delivery_dining</mat-icon>
                                        <span>Out for Delivery</span>
                                    </button>
                                    <button mat-menu-item *ngIf="order.status === 'out-for-delivery'"
                                        (click)="updateOrderStatus(order, 'delivered')">
                                        <mat-icon>home</mat-icon>
                                        <span>Mark as Delivered</span>
                                    </button>
                                    <button mat-menu-item *ngIf="['ready', 'delivered'].includes(order.status)"
                                        (click)="updateOrderStatus(order, 'completed')">
                                        <mat-icon>task_alt</mat-icon>
                                        <span>Complete Order</span>
                                    </button>
                                    <button mat-menu-item *ngIf="!['completed', 'cancelled'].includes(order.status)"
                                        (click)="updateOrderStatus(order, 'cancelled')">
                                        <mat-icon>cancel</mat-icon>
                                        <span>Cancel Order</span>
                                    </button>
                                </mat-menu>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openOrderDetail(row)"
                            class="order-row"></tr>

                        <!-- Row shown when there is no matching data. -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="7">No orders found</td>
                        </tr>
                    </table>

                    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>