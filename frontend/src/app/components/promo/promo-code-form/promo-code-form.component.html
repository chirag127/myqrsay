<div class="container">
    <div class="page-header">
        <h1>{{ isEditMode ? 'Edit' : 'Create' }} Promo Code</h1>
        <div class="action-buttons">
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="submitting">
                <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Save' }}
            </button>
            <a mat-raised-button routerLink="/admin/promo-codes">
                <mat-icon>arrow_back</mat-icon> Back
            </a>
        </div>
    </div>

    <div *ngIf="loading" class="loading-spinner">
        <mat-spinner></mat-spinner>
    </div>

    <form [formGroup]="promoForm" *ngIf="!loading" class="promo-form">
        <mat-card>
            <mat-card-header>
                <mat-card-title>Basic Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="form-row code-row">
                    <mat-form-field appearance="outline">
                        <mat-label>Promo Code</mat-label>
                        <input matInput formControlName="code" placeholder="e.g., SUMMER20" autocapitalize="characters">
                        <mat-hint>3-15 characters, uppercase letters, numbers, hyphens, and underscores only</mat-hint>
                        <mat-error *ngIf="promoForm.get('code')?.hasError('required')">Promo code is
                            required</mat-error>
                        <mat-error *ngIf="promoForm.get('code')?.hasError('pattern')">Invalid promo code
                            format</mat-error>
                    </mat-form-field>
                    <button mat-raised-button type="button" color="accent" (click)="generateRandomCode()">
                        <mat-icon>autorenew</mat-icon> Generate
                    </button>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description"
                            placeholder="Enter a description for this promo code" rows="2"></textarea>
                        <mat-error *ngIf="promoForm.get('description')?.hasError('maxlength')">Description cannot exceed
                            200 characters</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row two-columns">
                    <mat-form-field appearance="outline">
                        <mat-label>Discount Type</mat-label>
                        <mat-select formControlName="discountType">
                            <mat-option value="percentage">Percentage (%)</mat-option>
                            <mat-option value="fixed">Fixed Amount ($)</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Discount Value</mat-label>
                        <input matInput type="number" formControlName="discountValue" min="0" step="0.01">
                        <span matPrefix *ngIf="promoForm.get('discountType')?.value === 'percentage'">%&nbsp;</span>
                        <span matPrefix *ngIf="promoForm.get('discountType')?.value === 'fixed'">$&nbsp;</span>
                        <mat-error *ngIf="promoForm.get('discountValue')?.hasError('required')">Discount value is
                            required</mat-error>
                        <mat-error *ngIf="promoForm.get('discountValue')?.hasError('min')">Discount value cannot be
                            negative</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row two-columns">
                    <mat-form-field appearance="outline">
                        <mat-label>Minimum Order Value</mat-label>
                        <input matInput type="number" formControlName="minOrderValue" min="0" step="0.01">
                        <span matPrefix>$&nbsp;</span>
                        <mat-hint>Set to 0 for no minimum</mat-hint>
                        <mat-error *ngIf="promoForm.get('minOrderValue')?.hasError('required')">Minimum order value is
                            required</mat-error>
                        <mat-error *ngIf="promoForm.get('minOrderValue')?.hasError('min')">Minimum order value cannot be
                            negative</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" *ngIf="promoForm.get('discountType')?.value === 'percentage'">
                        <mat-label>Maximum Discount Amount</mat-label>
                        <input matInput type="number" formControlName="maxDiscountAmount" min="0" step="0.01">
                        <span matPrefix>$&nbsp;</span>
                        <mat-hint>Leave empty for no maximum</mat-hint>
                        <mat-error *ngIf="promoForm.get('maxDiscountAmount')?.hasError('min')">Maximum discount amount
                            cannot be negative</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row two-columns">
                    <mat-form-field appearance="outline">
                        <mat-label>Valid From</mat-label>
                        <input matInput [matDatepicker]="startPicker" formControlName="validFrom">
                        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                        <mat-datepicker #startPicker></mat-datepicker>
                        <mat-error *ngIf="promoForm.get('validFrom')?.hasError('required')">Start date is
                            required</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Valid To</mat-label>
                        <input matInput [matDatepicker]="endPicker" formControlName="validTo">
                        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                        <mat-datepicker #endPicker></mat-datepicker>
                        <mat-error *ngIf="promoForm.get('validTo')?.hasError('required')">End date is
                            required</mat-error>
                    </mat-form-field>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card formGroupName="usageLimit">
            <mat-card-header>
                <mat-card-title>Usage Limits</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="form-row two-columns">
                    <mat-form-field appearance="outline">
                        <mat-label>Total Usage Limit</mat-label>
                        <input matInput type="number" formControlName="total" min="1">
                        <mat-hint>Leave empty for unlimited uses</mat-hint>
                        <mat-error *ngIf="promoForm.get('usageLimit.total')?.hasError('min')">Total usage limit must be
                            at least 1</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Per User Limit</mat-label>
                        <input matInput type="number" formControlName="perUser" min="1">
                        <mat-hint>How many times each user can use this code</mat-hint>
                        <mat-error *ngIf="promoForm.get('usageLimit.perUser')?.hasError('min')">Per user limit must be
                            at least 1</mat-error>
                    </mat-form-field>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card formGroupName="applicableFor">
            <mat-card-header>
                <mat-card-title>Applicability</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div formGroupName="orderTypes" class="section">
                    <h3>Order Types</h3>
                    <div class="checkbox-group">
                        <mat-checkbox formControlName="dineIn" color="primary">Dine-in</mat-checkbox>
                        <mat-checkbox formControlName="takeaway" color="primary">Takeaway</mat-checkbox>
                        <mat-checkbox formControlName="delivery" color="primary">Delivery</mat-checkbox>
                        <mat-checkbox formControlName="roomService" color="primary">Room Service</mat-checkbox>
                    </div>
                </div>

                <div formGroupName="userTypes" class="section">
                    <h3>User Types</h3>
                    <div class="checkbox-group">
                        <mat-checkbox formControlName="newUsers" color="primary">New Users</mat-checkbox>
                        <mat-checkbox formControlName="existingUsers" color="primary">Existing Users</mat-checkbox>
                    </div>
                </div>

                <div class="section">
                    <h3>Categories (Optional)</h3>
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Select Categories</mat-label>
                        <mat-select formControlName="categories" multiple>
                            <mat-option *ngFor="let category of categories" [value]="category._id">
                                {{ category.name }}
                            </mat-option>
                        </mat-select>
                        <mat-hint>Leave empty to apply to all categories</mat-hint>
                    </mat-form-field>
                </div>

                <div class="section">
                    <h3>Menu Items (Optional)</h3>
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Select Menu Items</mat-label>
                        <mat-select formControlName="menuItems" multiple>
                            <mat-option *ngFor="let item of menuItems" [value]="item._id">
                                {{ item.name }}
                            </mat-option>
                        </mat-select>
                        <mat-hint>Leave empty to apply to all menu items</mat-hint>
                    </mat-form-field>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card formGroupName="restrictions">
            <mat-card-header>
                <mat-card-title>Restrictions</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div formGroupName="daysOfWeek" class="section">
                    <h3>Days of Week</h3>
                    <div class="checkbox-group">
                        <mat-checkbox *ngFor="let day of daysOfWeek" [formControlName]="day.value" color="primary">
                            {{ day.name }}
                        </mat-checkbox>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h3>Meal Times</h3>
                        <button mat-mini-fab color="primary" type="button" (click)="addMealTime()" class="add-button">
                            <mat-icon>add</mat-icon>
                        </button>
                    </div>

                    <div formArrayName="mealTimes">
                        <div *ngFor="let mealTime of mealTimesArray.controls; let i = index" [formGroupName]="i"
                            class="meal-time-item">
                            <div class="meal-time-header">
                                <h4>Meal Time #{{ i + 1 }}</h4>
                                <button mat-icon-button color="warn" type="button" (click)="removeMealTime(i)"
                                    *ngIf="mealTimesArray.length > 1">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>
                            <div class="form-row three-columns">
                                <mat-form-field appearance="outline">
                                    <mat-label>Name</mat-label>
                                    <input matInput formControlName="name" placeholder="e.g., Lunch, Dinner">
                                    <mat-error *ngIf="mealTime.get('name')?.hasError('required')">Name is
                                        required</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Start Time</mat-label>
                                    <input matInput type="time" formControlName="startTime">
                                    <mat-error *ngIf="mealTime.get('startTime')?.hasError('required')">Start time is
                                        required</mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>End Time</mat-label>
                                    <input matInput type="time" formControlName="endTime">
                                    <mat-error *ngIf="mealTime.get('endTime')?.hasError('required')">End time is
                                        required</mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                        <div *ngIf="mealTimesArray.length === 0" class="no-items">
                            <p>No meal times added. Click the + button to add a meal time.</p>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-header>
                <mat-card-title>Status</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <mat-slide-toggle formControlName="isActive" color="primary">Active</mat-slide-toggle>
            </mat-card-content>
        </mat-card>

        <div class="form-actions">
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="submitting">
                <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Save' }} Promo Code
            </button>
            <a mat-button routerLink="/admin/promo-codes">Cancel</a>
        </div>
    </form>
</div>