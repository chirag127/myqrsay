<div class="container">
    <div class="page-header">
        <h1>{{ isEditMode ? 'Edit' : 'Add' }} Menu Item</h1>
        <div class="action-buttons">
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="submitting">
                <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Save' }}
            </button>
            <a mat-raised-button routerLink="/admin/menu-items">
                <mat-icon>arrow_back</mat-icon> Back
            </a>
        </div>
    </div>

    <div *ngIf="loading" class="loading-spinner">
        <mat-spinner></mat-spinner>
    </div>

    <form [formGroup]="menuItemForm" *ngIf="!loading" class="menu-item-form">
        <mat-card>
            <mat-card-header>
                <mat-card-title>Basic Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Name</mat-label>
                        <input matInput formControlName="name" placeholder="Enter dish name">
                        <mat-error *ngIf="menuItemForm.get('name')?.hasError('required')">Name is required</mat-error>
                        <mat-error *ngIf="menuItemForm.get('name')?.hasError('maxlength')">Name cannot exceed 100
                            characters</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" placeholder="Enter dish description"
                            rows="3"></textarea>
                        <mat-error *ngIf="menuItemForm.get('description')?.hasError('maxlength')">Description cannot
                            exceed 500 characters</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row two-columns">
                    <mat-form-field appearance="outline">
                        <mat-label>Category</mat-label>
                        <mat-select formControlName="category">
                            <mat-option *ngFor="let category of categories" [value]="category._id">
                                {{ category.name }}
                            </mat-option>
                        </mat-select>
                        <mat-error *ngIf="menuItemForm.get('category')?.hasError('required')">Category is
                            required</mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline">
                        <mat-label>Base Price</mat-label>
                        <input matInput type="number" formControlName="price" min="0" step="0.01">
                        <span matPrefix>$&nbsp;</span>
                        <mat-error *ngIf="menuItemForm.get('price')?.hasError('required')">Price is required</mat-error>
                        <mat-error *ngIf="menuItemForm.get('price')?.hasError('min')">Price cannot be
                            negative</mat-error>
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <div class="image-upload-container">
                        <div class="image-preview" *ngIf="imagePreview">
                            <img [src]="imagePreview" alt="Preview">
                            <button mat-mini-fab color="warn" class="remove-image" (click)="removeImage()">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <button mat-stroked-button type="button" (click)="fileInput.click()" *ngIf="!imagePreview">
                            <mat-icon>add_photo_alternate</mat-icon> Upload Image
                        </button>
                        <input hidden type="file" #fileInput (change)="onImageSelected($event)" accept="image/*">
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-header>
                <mat-card-title>Variants</mat-card-title>
                <button mat-mini-fab color="primary" type="button" (click)="addVariant()" class="add-button">
                    <mat-icon>add</mat-icon>
                </button>
            </mat-card-header>
            <mat-card-content>
                <div formArrayName="variants">
                    <div *ngFor="let variant of variantsArray.controls; let i = index" [formGroupName]="i"
                        class="variant-item">
                        <div class="variant-header">
                            <h3>Variant #{{ i + 1 }}</h3>
                            <button mat-icon-button color="warn" type="button" (click)="removeVariant(i)">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <div class="form-row three-columns">
                            <mat-form-field appearance="outline">
                                <mat-label>Name</mat-label>
                                <input matInput formControlName="name" placeholder="e.g., Small, Medium, Large">
                                <mat-error *ngIf="variant.get('name')?.hasError('required')">Name is
                                    required</mat-error>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                                <mat-label>Price</mat-label>
                                <input matInput type="number" formControlName="price" min="0" step="0.01">
                                <span matPrefix>$&nbsp;</span>
                                <mat-error *ngIf="variant.get('price')?.hasError('required')">Price is
                                    required</mat-error>
                                <mat-error *ngIf="variant.get('price')?.hasError('min')">Price cannot be
                                    negative</mat-error>
                            </mat-form-field>

                            <mat-slide-toggle formControlName="isAvailable" color="primary">Available</mat-slide-toggle>
                        </div>
                    </div>
                    <div *ngIf="variantsArray.length === 0" class="no-items">
                        <p>No variants added. Click the + button to add a variant.</p>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-header>
                <mat-card-title>Add-ons</mat-card-title>
                <button mat-mini-fab color="primary" type="button" (click)="addAddon()" class="add-button">
                    <mat-icon>add</mat-icon>
                </button>
            </mat-card-header>
            <mat-card-content>
                <div formArrayName="addons">
                    <div *ngFor="let addon of addonsArray.controls; let i = index" [formGroupName]="i"
                        class="addon-item">
                        <div class="addon-header">
                            <h3>Add-on Group #{{ i + 1 }}</h3>
                            <button mat-icon-button color="warn" type="button" (click)="removeAddon(i)">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <div class="form-row">
                            <mat-form-field appearance="outline" class="full-width">
                                <mat-label>Name</mat-label>
                                <input matInput formControlName="name" placeholder="e.g., Toppings, Sauces">
                                <mat-error *ngIf="addon.get('name')?.hasError('required')">Name is required</mat-error>
                            </mat-form-field>
                        </div>

                        <div class="form-row two-columns">
                            <div class="checkbox-group">
                                <mat-checkbox formControlName="required" color="primary">Required</mat-checkbox>
                                <mat-checkbox formControlName="multiple" color="primary">Multiple
                                    Selection</mat-checkbox>
                            </div>

                            <div class="form-row two-columns" *ngIf="addon.get('multiple')?.value">
                                <mat-form-field appearance="outline">
                                    <mat-label>Min Selections</mat-label>
                                    <input matInput type="number" formControlName="min" min="0">
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Max Selections</mat-label>
                                    <input matInput type="number" formControlName="max" min="0">
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="addon-options">
                            <div class="addon-options-header">
                                <h4>Options</h4>
                                <button mat-mini-fab color="accent" type="button" (click)="addAddonOption(i)"
                                    class="add-option-button">
                                    <mat-icon>add</mat-icon>
                                </button>
                            </div>

                            <div formArrayName="options">
                                <div *ngFor="let option of getAddonOptionsArray(i).controls; let j = index"
                                    [formGroupName]="j" class="option-item">
                                    <div class="form-row three-columns">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Name</mat-label>
                                            <input matInput formControlName="name"
                                                placeholder="e.g., Cheese, Mushrooms">
                                            <mat-error *ngIf="option.get('name')?.hasError('required')">Name is
                                                required</mat-error>
                                        </mat-form-field>

                                        <mat-form-field appearance="outline">
                                            <mat-label>Additional Price</mat-label>
                                            <input matInput type="number" formControlName="price" min="0" step="0.01">
                                            <span matPrefix>$&nbsp;</span>
                                            <mat-error *ngIf="option.get('price')?.hasError('required')">Price is
                                                required</mat-error>
                                            <mat-error *ngIf="option.get('price')?.hasError('min')">Price cannot be
                                                negative</mat-error>
                                        </mat-form-field>

                                        <div class="option-actions">
                                            <mat-slide-toggle formControlName="isAvailable"
                                                color="primary">Available</mat-slide-toggle>
                                            <button mat-icon-button color="warn" type="button"
                                                (click)="removeAddonOption(i, j)">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div *ngIf="getAddonOptionsArray(i).length === 0" class="no-items">
                                    <p>No options added. Click the + button to add an option.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="addonsArray.length === 0" class="no-items">
                        <p>No add-ons added. Click the + button to add an add-on group.</p>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card>
            <mat-card-header>
                <mat-card-title>Availability & Settings</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div formGroupName="availability" class="availability-section">
                    <h3>Availability</h3>
                    <div class="checkbox-group">
                        <mat-checkbox formControlName="dineIn" color="primary">Dine-in</mat-checkbox>
                        <mat-checkbox formControlName="takeaway" color="primary">Takeaway</mat-checkbox>
                        <mat-checkbox formControlName="delivery" color="primary">Delivery</mat-checkbox>
                        <mat-checkbox formControlName="roomService" color="primary">Room Service</mat-checkbox>
                    </div>
                </div>

                <div class="dietary-section">
                    <h3>Dietary Information</h3>
                    <div class="checkbox-group">
                        <mat-checkbox formControlName="isVegetarian" color="primary">Vegetarian</mat-checkbox>
                        <mat-checkbox formControlName="isVegan" color="primary">Vegan</mat-checkbox>
                        <mat-checkbox formControlName="isGlutenFree" color="primary">Gluten Free</mat-checkbox>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Spicy Level</mat-label>
                            <mat-select formControlName="spicyLevel">
                                <mat-option [value]="0">Not Spicy</mat-option>
                                <mat-option [value]="1">Mild</mat-option>
                                <mat-option [value]="2">Medium</mat-option>
                                <mat-option [value]="3">Hot</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Allergens</mat-label>
                            <mat-select formControlName="allergens" multiple>
                                <mat-option value="gluten">Gluten</mat-option>
                                <mat-option value="dairy">Dairy</mat-option>
                                <mat-option value="nuts">Nuts</mat-option>
                                <mat-option value="soy">Soy</mat-option>
                                <mat-option value="eggs">Eggs</mat-option>
                                <mat-option value="fish">Fish</mat-option>
                                <mat-option value="shellfish">Shellfish</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>

                <div formGroupName="nutritionalInfo" class="nutritional-section">
                    <h3>Nutritional Information (Optional)</h3>
                    <div class="form-row five-columns">
                        <mat-form-field appearance="outline">
                            <mat-label>Calories</mat-label>
                            <input matInput type="number" formControlName="calories" min="0">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Protein (g)</mat-label>
                            <input matInput type="number" formControlName="protein" min="0">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Carbs (g)</mat-label>
                            <input matInput type="number" formControlName="carbs" min="0">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Fat (g)</mat-label>
                            <input matInput type="number" formControlName="fat" min="0">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Fiber (g)</mat-label>
                            <input matInput type="number" formControlName="fiber" min="0">
                        </mat-form-field>
                    </div>
                </div>

                <div class="other-settings-section">
                    <h3>Other Settings</h3>
                    <div class="form-row two-columns">
                        <mat-form-field appearance="outline">
                            <mat-label>Preparation Time (minutes)</mat-label>
                            <input matInput type="number" formControlName="preparationTime" min="1">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Display Order</mat-label>
                            <input matInput type="number" formControlName="displayOrder" min="0">
                            <mat-hint>Lower numbers appear first</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="checkbox-group">
                        <mat-checkbox formControlName="isAvailable" color="primary">Available</mat-checkbox>
                        <mat-checkbox formControlName="isFeatured" color="primary">Featured</mat-checkbox>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <div class="form-actions">
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="submitting">
                <mat-icon>save</mat-icon> {{ isEditMode ? 'Update' : 'Save' }} Menu Item
            </button>
            <a mat-button routerLink="/admin/menu-items">Cancel</a>
        </div>
    </form>
</div>